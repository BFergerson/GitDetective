!function(e){if("function"==typeof require&&"undefined"!=typeof module){var n=require("sockjs-client");if(!n)throw new Error("vertx-eventbus.js requires sockjs-client, see http://sockjs.org");e(n)}else if("function"==typeof define&&define.amd)define("vertx-eventbus",["sockjs"],e);else{if(void 0===this.SockJS)throw new Error("vertx-eventbus.js requires sockjs-client, see http://sockjs.org");EventBus=e(this.SockJS)}}(function(e){function n(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e,n){return n=16*Math.random(),("y"==e?3&n|8:0|n).toString(16)})}function t(e,n){if(e){if(!n)return e;for(var t in e)e.hasOwnProperty(t)&&void 0===n[t]&&(n[t]=e[t])}return n||{}}var r=function(n,t){var o=this;t=t||{},this.pingInterval=t.vertxbus_ping_interval||5e3,this.pingTimerID=null,this.reconnectEnabled=!1,this.reconnectAttempts=0,this.reconnectTimerID=null,this.maxReconnectAttempts=t.vertxbus_reconnect_attempts_max||1/0,this.reconnectDelayMin=t.vertxbus_reconnect_delay_min||1e3,this.reconnectDelayMax=t.vertxbus_reconnect_delay_max||5e3,this.reconnectExponent=t.vertxbus_reconnect_exponent||2,this.randomizationFactor=t.vertxbus_randomization_factor||.5;var s=function(){var e=o.reconnectDelayMin*Math.pow(o.reconnectExponent,o.reconnectAttempts);if(o.randomizationFactor){var n=Math.random(),t=Math.floor(n*o.randomizationFactor*e);e=0==(1&Math.floor(10*n))?e-t:e+t}return 0|Math.min(e,o.reconnectDelayMax)};this.defaultHeaders=null,this.onerror=function(e){try{console.error(e)}catch(e){}};var i=function(){o.sockJSConn=new e(n,null,t),o.state=r.CONNECTING,o.handlers={},o.replyHandlers={},o.sockJSConn.onopen=function(){o.enablePing(!0),o.state=r.OPEN,o.onopen&&o.onopen(),o.reconnectTimerID&&(o.reconnectAttempts=0,o.onreconnect&&o.onreconnect())},o.sockJSConn.onclose=function(e){o.state=r.CLOSED,o.pingTimerID&&clearInterval(o.pingTimerID),o.reconnectEnabled&&o.reconnectAttempts<o.maxReconnectAttempts&&(o.sockJSConn=null,o.reconnectTimerID=setTimeout(i,s()),++o.reconnectAttempts),o.onclose&&o.onclose(e)},o.sockJSConn.onmessage=function(e){var n=JSON.parse(e.data);if(n.replyAddress&&Object.defineProperty(n,"reply",{value:function(e,t,r){o.send(n.replyAddress,e,t,r)}}),o.handlers[n.address])for(var t=o.handlers[n.address],r=0;r<t.length;r++)"err"===n.type?t[r]({failureCode:n.failureCode,failureType:n.failureType,message:n.message}):t[r](null,n);else if(o.replyHandlers[n.address]){var s=o.replyHandlers[n.address];delete o.replyHandlers[n.address],"err"===n.type?s({failureCode:n.failureCode,failureType:n.failureType,message:n.message}):s(null,n)}else if("err"===n.type)o.onerror(n);else try{console.warn("No handler found for message: ",n)}catch(e){}}};i()};if(r.prototype.send=function(e,o,s,i){if(this.state!=r.OPEN)throw new Error("INVALID_STATE_ERR");"function"==typeof s&&(i=s,s={});var a={type:"send",address:e,headers:t(this.defaultHeaders,s),body:o};if(i){var c=n();a.replyAddress=c,this.replyHandlers[c]=i}this.sockJSConn.send(JSON.stringify(a))},r.prototype.publish=function(e,n,o){if(this.state!=r.OPEN)throw new Error("INVALID_STATE_ERR");this.sockJSConn.send(JSON.stringify({type:"publish",address:e,headers:t(this.defaultHeaders,o),body:n}))},r.prototype.registerHandler=function(e,n,o){if(this.state!=r.OPEN)throw new Error("INVALID_STATE_ERR");"function"==typeof n&&(o=n,n={}),this.handlers[e]||(this.handlers[e]=[],this.sockJSConn.send(JSON.stringify({type:"register",address:e,headers:t(this.defaultHeaders,n)}))),this.handlers[e].push(o)},r.prototype.unregisterHandler=function(e,n,o){if(this.state!=r.OPEN)throw new Error("INVALID_STATE_ERR");var s=this.handlers[e];if(s){"function"==typeof n&&(o=n,n={});var i=s.indexOf(o);-1!=i&&(s.splice(i,1),0===s.length&&(this.sockJSConn.send(JSON.stringify({type:"unregister",address:e,headers:t(this.defaultHeaders,n)})),delete this.handlers[e]))}},r.prototype.close=function(){this.state=r.CLOSING,this.enableReconnect(!1),this.sockJSConn.close()},r.CONNECTING=0,r.OPEN=1,r.CLOSING=2,r.CLOSED=3,r.prototype.enablePing=function(e){var n=this;if(e){var t=function(){n.sockJSConn.send(JSON.stringify({type:"ping"}))};n.pingInterval>0&&(t(),n.pingTimerID=setInterval(t,n.pingInterval))}else n.pingTimerID&&(clearInterval(n.pingTimerID),n.pingTimerID=null)},r.prototype.enableReconnect=function(e){var n=this;n.reconnectEnabled=e,!e&&n.reconnectTimerID&&(clearTimeout(n.reconnectTimerID),n.reconnectTimerID=null,n.reconnectAttempts=0)},"undefined"==typeof exports)return r;"undefined"!=typeof module&&module.exports?exports=module.exports=r:exports.EventBus=r});